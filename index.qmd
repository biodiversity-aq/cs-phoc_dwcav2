---
title: "Mapping population census dataset to DwCA v2"
---

Attempt to map CS-PHOC dataset as a Survey use case of the [new data model](https://www.gbif.org/composition/HjlTr705BctcnaZkcjRJq/gbif-new-data-model) to DwCAv2.\
Data paper that describes the population census of phocids: <https://doi.org/10.1038/s41597-024-03744-9>\
Dataset is available as Darwin Core Archive at <https://ipt-obis.gbif.us/resource?r=usamlr_cs-phoc>

## Load libraries

```{r load library}
#| warning: false
#| message: false
library(here)
library(tidyverse)
```

## Read files

```{r read files}
#| warning: false

event <- read_delim("https://raw.githubusercontent.com/us-amlr/cs-phoc/refs/heads/main/data/dwca/event.txt", delim = "\t", show_col_types = FALSE)
occ <- read_delim("https://raw.githubusercontent.com/us-amlr/cs-phoc/refs/heads/main/data/dwca/occurrence.txt", delim = "\t", show_col_types = FALSE)
```

## DwCA v2

The mapping is based on schema from <https://rs.gbif.org/sandbox/experimental/data-packages/dwca_v2/0.1/>

### Event table

```{r event}

event <- event %>%
  mutate(
    eventClass = "Survey",
    eventType = "Survey", 
    eventProtocolID = "CS-PHOC-Census" 
  )
```

### Survey table

```{r survey}

survey <- event %>%
  select(eventID, sampleSizeValue, sampleSizeUnit, dynamicProperties) %>%
  rename(
    surveyID = eventID,
    eventDurationValue = sampleSizeValue,
    eventDurationUnit = sampleSizeUnit
  ) %>%
  mutate(
    targetTaxonomicScope = "Lobodon carcinophaga | Mirounga leonina | Leptonychotes weddellii | Hydrurga leptonyx",
    taxonCompletenessReported = "", # TODO
    taxonCompletenessProtocols = "census",
    isTaxonomicScopeFullyReported = "true", 
    isAbsenceReported = "true", # does not need absentTaxa
    hasNonTargetTaxa = "false",
    isAbundanceReported = "true",
    isLeastSpecificTargetCategoryQuantityInclusive = "false", 
    hasMaterialSamples = "false",
    isSamplingEffortReported = "false",
    samplingPerformedBy = case_when(
      str_detect(dynamicProperties, "INACH") ~ "INACH",
      str_detect(dynamicProperties, "USAMLR") ~ "USAMLR",
      TRUE ~ NA_character_  # Default for unmatched cases
    )
  ) 
```

### Survey-target table

From paper:

> Biologists used field notebooks to record counts of each phocid species at each location, along with age class and sex when possible.

Should `sex` and `lifeStage` be part of survey target? It is not always possible to record these values. Is `unknown` a valid value?

```{r survey-target}

survey_target_taxa <- occ %>%
  distinct(scientificName) %>%
  rename(surveyTargetValue = scientificName) %>%
  mutate(
    surveyTargetType = "taxon",
    includeOrExclude = "include",
    surveyTargetID = case_when(
      surveyTargetValue == "Lobodon carcinophaga" ~ "344008",
      surveyTargetValue == "Mirounga leonina" ~ "231413",
      surveyTargetValue == "Hydrurga leptonyx" ~ "231417",
      surveyTargetValue == "Leptonychotes weddellii" ~ "195932",
      TRUE ~ NA_character_  # Handles cases where no match is found
      ) 
    )

# repeat all survey_target_taxa for each surveyID
survey_target <- survey %>% 
  select(surveyID) %>%
  crossing(survey_target_taxa) # repeat target taxa for all surveyID
```

### Survey-target-abundance table

`sex` and `lifeStage` need to be specified with Assertions when it is not specified as part of target. However, there is no `surveyTargetAbundanceID` in this table, so how can I point `Assertion` record to `surveyTargetAbundance` record?

```{r survey-target-abundance}

survey_target_abd <- occ %>%
  select(scientificName, scientificNameID, individualCount, sex, lifeStage) %>%
  rename(
    observedTaxon = scientificName,
    observedTaxonID = scientificNameID,
    organismQuantity = individualCount
    ) %>%
  mutate(
    organismQuantityType = case_when(
      organismQuantity <= 1 ~ "individual",
      organismQuantity > 1 ~ "individuals"
    ),
    surveyTargetID = case_when(
      observedTaxon == "Lobodon carcinophaga" ~ "344008",
      observedTaxon == "Mirounga leonina" ~ "231413",
      observedTaxon == "Hydrurga leptonyx" ~ "231417",
      observedTaxon == "Leptonychotes weddellii" ~ "195932",
      TRUE ~ NA_character_  # Handles cases where no match is found
      )
  )
```

### Protocol table

Protocols are linked in a weird way:\
- Event.eventProtocolID = `CS-PHOC-Census` = Protocol.protocolID\
- Protocol.protocolTargetID = Survey.surveyID = Event.eventID

Data protocol is only linked to Survey.surveyID. Does it make sense to have data protocol structured in this way?

```{r protocol}

census_protocol <- survey %>%
  select(surveyID) %>%
  rename(protocolTargetID = surveyID) %>%
  mutate(
    protocolID = "CS-PHOC-Census",
    protocolTargetType = "Survey",
    protocolType = "Census",
    protocolName = "census protocol",
    protocolDescription = "Trained field biologists surveyed safely accessible regions of Cape Shirreff and recorded all live phocids. Biologists used field notebooks to record counts of each phocid species at each location, along with age class and sex when possible. Phocids were only recorded if they were hauled out on land, and not if they were for instance on an ice flow or swimming just offshore. After the survey, data were entered into a database or otherwise archived. Locations were surveyed on foot, by either walking through haul-out locations or using binoculars from a high vantage point where practical. While the full extent of the area surveyed varied slightly both across and within seasons, core census locations were always surveyed. These core census locations span the vast majority of phocid haul-out locations at Cape Shirreff, thereby ensuring that CS-PHOC data are both consistent and representative of phocid haul-out at Cape Shirreff across all censuses and seasons.",
    protocolCitation = "Woodman, S.M., Borras-Chavez, R., Goebel, M.E. et al. CS-PHOC: weekly census counts of Southern Ocean phocids at Cape Shirreff, Livingston Island. Sci Data 11, 895 (2024). https://doi.org/10.1038/s41597-024-03744-9"
  )

data_protocol <- survey %>%
  select(surveyID) %>%
  rename(protocolTargetID = surveyID) %>%
  mutate(
    protocolID = "CS-PHOC-Data",
    protocolTargetType = "Survey",
    protocolType = "Data cleaning and aggregation",
    protocolName = "Data cleaning and aggregation",
    protocolDescription = "Data records were compiled from historical documents, field notebooks, Excel files, and a SQL Server database. INACH historical data (i.e., paper records, reports, and Excel files) were consolidated into Excel files. These INACH files, along with historical U.S. AMLR Excel files, were imported into the U.S. AMLR Pinniped SQL Server database using R (v4.3). Once in the database, all data were read into R, where they were cleaned and standardized as follows. Location names and count types (i.e., age class and sex) were converted to standard names, and columns containing count data were aggregated to the lowest resolution across datasets. For instance, some seasons male and female pup counts were recorded separately, but during others only a single count of all pups was recorded. Thus, for this dataset, all pup counts were aggregated to a single, total pup count for each survey record. In addition, recorded data varied slightly across programs. Specifically, data from INACH surveys included explicit zero records when there were none of a particular phocid species at a location, while data from U.S. AMLR surveys only included non-zero counts. To make these data consistent, U.S. AMLR data were made explicit by adding zero records as necessary. After data cleaning and standardization, records from the core census locations were grouped and aggregated to provide a single, comparable count for each species for each census. Specifically, records were filtered for core census locations, and counts were summed after grouping by census and species. These aggregated core census location counts, along with counts for one other location (Punta San Telmo, described in “Data Records” in the publication), make up the published CS-PHOC dataset.",
    protocolCitation = "Woodman, S.M., Borras-Chavez, R., Goebel, M.E. et al. CS-PHOC: weekly census counts of Southern Ocean phocids at Cape Shirreff, Livingston Island. Sci Data 11, 895 (2024). https://doi.org/10.1038/s41597-024-03744-9"
  )

protocol <- rbind(census_protocol, data_protocol)
```

## Write files

```{r write files}

write_tsv(event, here("output", "event.txt"))
write_tsv(survey, here("output", "survey.txt"))
write_tsv(survey_target, here("output", "survey_target.txt"))
write_tsv(survey_target_abd, here("output", "survey_target_abundance.txt"))
write_tsv(protocol, here("output", "protocol.txt"))
```

## Citation

Woodman, S.M., Borras-Chavez, R., Goebel, M.E. *et al.* CS-PHOC: weekly census counts of Southern Ocean phocids at Cape Shirreff, Livingston Island. *Sci Data* **11**, 895 (2024). https://doi.org/10.1038/s41597-024-03744-9
